<html>
	<head>
		<title>Pickr, by Hacker Club</title>
		<link rel="stylesheet" type="text/css"  href="pickre.css" />

		<!--
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.5.2.min.js"></script>
		-->
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
		<script type="text/javascript" >

var empty_rows = 0;

function show_error(e) {
    console.log(e);
    the_results_div = get_or_create_results_div().find('#the_results');
    the_results_div.empty();
    result_div = $('<div class="result"><h3>OH NOES! AN ERROR!</h3><div>');
    result_div.append(JSON.stringify(e));
    the_results_div.append(result_div);
    return true;
}
function show_results(results) {
    the_results_div = get_or_create_results_div().find('#the_results');
    the_results_div.empty();
    if(!results || results == '' || results == {}){
        result_div = $('<div class="result">No results :(</div>');
        the_results_div.append(result_div);
        return false;
    }
    for (key in results) {
        result = results[key];
        result_div = $('<div class="result"></div>');
        dept_num = $('<span class="dept_num_title">' + result['Department'] + result['Number'] + ': ' + result['title'] + '</span>');
        result_div.append(dept_num);
        //desc = $('<span class="desc">' + result['desc'] + '</span>');
        //result_div.append(desc);
        term = $('<span class="term">' + result['term'] + ' ' + result['year'] + '</span>');
        result_div.append(term);
        //year = $('<span class="year">' + result['year'] + '</span>');
        //result_div.append(year);
        profs_div = $('<span class="profs"></span>');
        num_profs = 0;
        for (key in result['Professors']) {
            prof = result['Professors'][key]
            if (num_profs > 0) {
                profs_div.append($(","));
            }
            profs_div.append($(prof));
        }
        result_div.append(prof);
        time = $('<span class="time">' + result['period'] + '</span>');
        result_div.append(time);
        crn = $('<span class="crn">CRN:' + result['CRN'] + '</span>');
        result_div.append(crn);
        if(result['dist'] && result['dist'].length > 0){
            distrib = $('<span class="distrib">Distrib:' + result['dist'] + '</span>');
        }
        else{
            distrib = $('<span class="distrib">No Distribs</span>');
        }
        result_div.append(distrib);
        if(result['wc']){
            wcult = $('<span class="wcult">WCULT:' + result['wc'] + '</span>');
        }
        else{
            wcult = $('<span class="wcult">No WCULT</span>');
        }
        result_div.append(wcult);
        if(result['nro'] == 'true'){
            nro = $('<span class="nro">Can NRO</span>');
        }
        else if(result['nro'] == 'false'){
            nro = $('<span class="nro">Can\'t NRO</span>');
        }
        result_div.append(nro);

        the_results_div.append(result_div);

/* this was written with the understanding that we would have a course/offering dichotomy. but now it looks like we won't, so we'll just toss this out for now
result = results[key];
result_div = $('<div class="result"></div>');
dept_num = $('<span class="dept_num">' + result['Department']+result['Number'] + '</span>');
result_div.append(dept_num);
desc = $('<span class="desc">' + result['desc'] + '</span>');
result_div.append(desc);
offerings_div = $('<div class="offerings"><h4>Current Offerings</h4></div>');
result_div.append(offerings_div);
for(key in result['current_offerings']){
offering = result['current_offerings'][key];
offering_div = $('<div class="offering"></div>');

term = $('<span class="term">' + offering['term'] + '</span>');
offering_div.append(term);
Professors = $('<span class="Professors">' + offering['Professors'] + '</span>');
offering_div.append(Professors);
time = $('<span class="time">' + offering['time'] + '</span>');
offering_div.append(time);
crn = $('<span class="crn">CRN:' + offering['crn'] + '</span>');
offering_div.append(crn);
offerings_div.append(offering_div);
}
the_results_div.append(result_div);
*/
    }
}

function get_or_create_results_div() {
    results_div = $('#results');
    if (results_div.length < 1) {
        results_div = $('\
            <div id="results"> \
            <h3> \
            Results \
            </h3> \
            <div id="the_results"> \
            </div> \
            ');
    }
    $('#results_container').append(results_div);
    return results_div;
}

function generate_input_field_quarter() {
    quarters = ['Fall', 'Winter', 'Spring', 'Summer'];
    date = new Date();
    this_year = date.getFullYear();
    years = [this_year, this_year+1]
    var html = '';
    html += '<select name="term">';
    for (key in quarters) {
        quarter = quarters[key];
        html += '<option value="' + quarter + '">' + quarter + '</option>';
    }
    html += '</select>';
    html += '<select name="year">';
    for (key in years) {
        year = years[key];
        html += '<option value="' + year+ '">' + year+ '</option>';
    }
    html += '</select>';
    //html += '<input name="year" id="year" type="text" size="5" value="' +date.getFullYear() + '">';
    return html;
}

function generate_input_field_time() {
    times = ['8', '9', '9L', '9S', '10', '11', '12', '2', '10A', '2A', '3A', '3B', ];
    html = '';
    html += '<span style="font-size: .7em;">';
    for (key in times) {
        time = times[key];
        html += '<input type="checkbox" name="period_' + time + '" value="1" />' + time;
    }
    html += '&nbsp;&nbsp;&nbsp;';
    html += '<a href="#" class="check_all">(All)</a>';
    html += '&nbsp;&nbsp;&nbsp;';
    html += '<a href="#" class="check_none">(None)</a>';
    html += '</span>';
    return html;
}

function generate_input_field_distrib() {
    distribs = ['ART', 'LIT', 'TMV', 'INT', 'SOC', 'QDS', 'SCI', 'SLA', 'TAS', 'TLA', ];
    html = '';
    html += '<span style="font-size: .7em;">';
    for (key in distribs) {
        distrib = distribs[key];
        html += '<input type="checkbox" name="distrib_' + distrib + '" value="1" />' + distrib;
    }
    html += '&nbsp;&nbsp;&nbsp;';
    html += '<a href="#" class="check_all">(All)</a>';
    html += '&nbsp;&nbsp;&nbsp;';
    html += '<a href="#" class="check_none">(None)</a>';
    html += '</span>';
    return html;
}

var search_options = {
    'Professors': {
        'long_name': 'Professor',
        'input_field': '<input type="text" name="Professors" id="Professors" value=""/>',
    },
    'title': {
        'long_name': 'Title',
        'input_field': '<input type="text" name="title" id="title" value=""/>',
    },
    'Names': {
        'long_name': 'Department',
        'input_field': '<input type="text" name="Department" id="dept" value=""/>',
    },
    'time': {
        'long_name': 'Meeting Time',
        'input_field': generate_input_field_time(),
    },
    'term': {
        'long_name': 'Quarter',
        'input_field': generate_input_field_quarter(),
    },
    'dist': {
        'long_name': 'Distrib',
        'input_field': generate_input_field_distrib(),
    },
    'wc': {
        'long_name': 'World Culture',
        'input_field': '\
<select name="wc"><option value="W">W</option><option value="NW">NW</option><option value="CI">CI</option></select>',
    },
    /*
    'median_grade': {
        'long_name': 'Median Grade',
        'input_field': ' \
<select name="median_grade" > \
<option value=">=A">A</option> \
<option value=">=A-">A- or higher</option> \
<option value=">=B+">B+ or higher</option> \
<option value=">=B">B or higher</option> \
<option value=">=B-">B- or higher</option> \
</select> \
',
    },
    */
    'nro': {
        'long_name': 'Can NRO?',
        'input_field': '<input type="checkbox" name="nro" value="true" checked="checked"/>Heck Yeah',
    },
/*
'enrollment_cap':  {
'long_name' : 'Enrollment Cap',
'input_field' : '<input type="text" name="" id="" value="" />',
},
*/
    /*
    'space_left': {
        'long_name': 'Space Left?',
        'input_field': '<input type="checkbox" checked="checked" />Heck Yeah',
    },
    */
};

function make_left_side_dropdown() {
    var dropdown = $('<select name="criteria"></select>');
    var first_option = $('<option value="null">---Choose Criteria---</option>');
    dropdown.append(first_option);
    for (var key in search_options) {
        var settings = search_options[key];
        var option_tag = $('<option></option>');
        option_tag.attr('value', key);
        option_tag.html(settings['long_name']);
        dropdown.append(option_tag);
    }
    dropdown.change(function () {
        choice = $(this).val();
        old_value = dropdown.data('old_value');
        dropdown.data('old_value', choice);
        if (choice == 'null') {
            var right_side_html = '';
            if (!$(this).data('is_empty')) {
                empty_rows++;
                $(this).data('is_empty', true);
            }
        } else {
            $(this).children('[value="null"]').hide();
            search_options[choice]['in_use'] = true;
            var right_side_html = search_options[choice]['input_field'];
            if ($(this).data('is_empty')) {
                empty_rows--;
                $(this).data('is_empty', false);
            }
        }
        if(!old_value){
            $(this).parent().children('.close_row').show();
        }
        if (old_value) {
            search_options[old_value]['in_use'] = false;
        }
        var right_side = $(this).parents('fieldset.search_row').find('.right_side')
        right_side.html(right_side_html);
        add_search_row_if_we_need_one();
    });
    dropdown.data('is_empty', true);
    dropdown.mouseenter(function () {
        for (key in search_options) {
            if (search_options[key]['in_use']) {
                $(this).find("option[value='" + key + "']").hide();

            } else {
                $(this).find("option[value='" + key + "']").show();
            }
        }
    });
    return dropdown

}

function add_search_row_if_we_need_one() {
    while (empty_rows <= 0) {
        insert_search_row_dom_element();
    }
    $(".check_all").click(function () {
        $(this).parent().children("input").attr('checked', 'checked');
    });
    $(".check_none").click(function () {
        $(this).parent().children("input").attr('checked', '');
    });
    $(".close_row").click(function () {
        $(this).parent().parent().hide();
    });
}

function make_search_row_dom_element() {
    row = $(' <fieldset class="search_row"> </fieldset> ');
    left_side = $(' <fieldset class="left_side"> </fieldset> ');
    close_link = $('<a href="#" class="close_row">X</a>');
    left_side.append(close_link);
    close_link.hide();
    left_side.append(make_left_side_dropdown());
    right_side = $(' <fieldset class="right_side"></fieldset> ');
    row.append(left_side);
    row.append(right_side);
    return row[0];
}

function get_search_form() {
    return $('#search_form');
}

function insert_search_row_dom_element() {
    row = make_search_row_dom_element();
    get_search_form().find('.rows').append(row);
    empty_rows++;
    return row;
}

function do_search() {
    query_url = 'http://hacktown.cs.dartmouth.edu/search/courses/courses/_search';
    the_form = $('#search_form');
    form_params = the_form.serializeArray();
    periods = [];
    distribs = [];

    queries = [];
    for (key in form_params) {
        if (form_params[key]['name'] == 'criteria') {
            continue;
        } else if (form_params[key]['name'].substring(0, 7) == 'period_') {
            // grab the period param
            if (form_params[key]['value'] == '1') {
                periods.push(form_params[key]['name'].substring(7));
            }
        } else if (form_params[key]['name'].substring(0, 8) == 'distrib_') {
            // grab the distrib param
            if (form_params[key]['value'] == '1') {
                distribs.push(form_params[key]['name'].substring(8));
            }
        }  else if(form_params[key]['value'] && form_params[key]['value'] != ''){
            i = {}; //hash needs to be built at runtime
            i[form_params[key]['name']] = form_params[key]['value'];
            queries.push({
                "field": i
            });
        }
    }
    if (periods.length > 0) {
    	i = {
            "field": {
                "period": periods.join(' ')
            }
       };
        queries.push(i);
    }
    if (distribs.length > 0) {
        console.log(distribs);
    	i = {
            "field": {
                "dist": distribs.join(' ')
            }
       };
        queries.push(i);
    }
    search_params = {
        "size": 9000,
        "query": {"bool": { "must":  queries}}
    };
    console.log(JSON.stringify(search_params));
    $.ajax({
        dataType: "json",
        type: "POST",
        url: query_url,
        data: JSON.stringify(search_params),
        success: function (data) {
            //we only want the juicy part of the data
            //console.log(JSON.stringify(data));
            data = data['hits']['hits'];
            for (key in data) {
                data[key] = data[key]["_source"];
                //pull the Department, number, section info out of the "names" field
                data[key]['Department'] = data[key]["names"][0]["Department"];
                data[key]['Number'] = data[key]["names"][0]["Number"];
                data[key]['Section'] = data[key]["names"][0]["Section"];
            }
            show_results(data);
        },
        error: function (e) {
            show_error(e);
        }
    });
}
//RUN THIS STUFF AT PAGE LOAD
$().ready(function () {
    for (key in search_options) {
        search_options[key]['in_use'] = false;
    }

    row1 = insert_search_row_dom_element();
    row1 = $(row1);

    //row2 = insert_search_row_dom_element();
    //row2 = $(row2);

    row1.find("select option:selected").removeAttr('selected');
    row1.find("select option[value='term']").attr('selected', 'selected');
    row1.find("select").change();

    //row2.find("select option:selected").removeAttr('selected');
    //row2.find("select option[value='time']").attr('selected', 'selected');
    //row2.find("select").change();

    //show_favorites();
    $("form#search_form input[type='submit']").click(function () {
    	try{
        	do_search();
        }catch(e){
        	alert(e.message)
        }
        return false;
    });
});	</script>
	</head>
	<body>
		<div id="header">
			<h1>Pickr</h1>
			<h2>
			by
			<a href="http://hacktown.cs.dartmouth.edu">hacker club</a>
			</h2>
		</div>
		<div id="content">

			<div id="search">
				<h3>Search</h3>
				<form method="" action="" id="search_form">
					<fieldset class="rows">
					</fieldset>
					<input type="submit" value="Search &raquo;"/>
				</form>
			</div>
			<div id="results_container">
			</div>
			<!--
			<div id="favorites">

			<h2>
			Favorites
			</h2>

			</div>
			-->
		</div>
	</body>
</html>
